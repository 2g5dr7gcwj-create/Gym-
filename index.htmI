<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BEAST TRACKER | تتبع الوحش</title>

    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Beast Tracker">
    <link rel="apple-touch-icon" href="/icon-192x192.png"> <meta name="theme-color" content="#0a0a0a">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background-color: #0a0a0a; color: #ffffff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .red-gradient { background: linear-gradient(135deg, #ff0000 0%, #8b0000 100%); }
        .card-dark { background: #1a1a1a; border: 1px solid #333; }
        .input-dark { background: #262626; border: 1px solid #444; color: white; padding: 1rem; border-radius: 0.75rem; width: 100%; transition: all 0.2s ease-in-out; }
        .input-dark:focus { border-color: #ff0000; outline: none; box-shadow: 0 0 0 2px rgba(255, 0, 0, 0.5); }
        .btn-red { background-color: #ff0000; color: white; padding: 1rem 1.5rem; border-radius: 0.75rem; font-weight: bold; transition: all 0.2s ease-in-out; }
        .btn-red:hover { transform: scale(1.02); background-color: #cc0000; }
        .btn-red:active { transform: scale(0.98); }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-2xl mx-auto pb-20"> <div class="flex items-center justify-between mb-8 border-b-2 border-red-600 pb-4">
            <h1 class="text-4xl font-black italic tracking-tighter text-red-600">BEAST <span class="text-white">TRACKER</span></h1>
            <i data-lucide="dumbbell" class="text-red-600 w-10 h-10"></i>
        </div>

        <div class="card-dark p-6 rounded-2xl shadow-2xl mb-8">
            <h2 class="text-2xl font-bold mb-5 flex items-center gap-3 text-white">
                <i data-lucide="plus-circle" class="text-red-500 w-6 h-6"></i> إضافة تمرين جديد
            </h2>
            <div class="grid grid-cols-1 gap-4">
                <input type="text" id="exerciseName" placeholder="اسم التمرين (مثلاً: بنج برس)" class="input-dark">
                <div class="flex gap-4">
                    <input type="number" id="weight" placeholder="الوزن (KG)" class="input-dark text-center" min="1" step="0.5">
                    <input type="number" id="reps" placeholder="التكرارات" class="input-dark text-center" min="1">
                </div>
                <button onclick="addEntry()" class="red-gradient w-full py-4 rounded-xl font-black text-lg hover:scale-[1.02] transition-transform active:scale-95 shadow-lg shadow-red-900/40">
                    تسجيل القوة الآن!
                </button>
            </div>
        </div>

        <div class="card-dark p-6 rounded-2xl shadow-2xl mb-8">
            <h2 class="text-2xl font-bold mb-5 flex items-center gap-3 text-white">
                <i data-lucide="line-chart" class="text-red-500 w-6 h-6"></i> تطور قوة الوحش
            </h2>
            <canvas id="beastChart"></canvas>
        </div>

        <div class="space-y-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-400 flex items-center gap-2">
                    <i data-lucide="clipboard-list" class="text-gray-400 w-5 h-5"></i> سجل التمارين المحفوظ
                </h3>
                <button onclick="clearAll()" class="text-sm text-red-500 underline hover:text-red-400 transition-colors">
                    <i data-lucide="trash-2" class="inline-block w-4 h-4 ml-1"></i> مسح الكل
                </button>
            </div>
            <div id="logsContainer" class="space-y-3">
                </div>
        </div>
    </div>

    <script>
        // 1. PWA Service Worker (لجعل التطبيق يعمل offline ويتحمل على الشاشة الرئيسية)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registered: ', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }

        // Initialize Icons from Lucide
        lucide.createIcons();

        let myChart; // Variable to hold the Chart.js instance

        // Function to calculate 1RM (One-Rep Max) - Epley Formula
        function calculate1RM(weight, reps) {
            if (reps === 0) return 0;
            return weight * (1 + (reps / 30));
        }

        // Function to add a new workout entry
        function addEntry() {
            const name = document.getElementById('exerciseName').value.trim();
            const weight = parseFloat(document.getElementById('weight').value);
            const reps = parseInt(document.getElementById('reps').value);
            const date = new Date().toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' }); // e.g., 20 مايو

            if (!name || isNaN(weight) || isNaN(reps) || weight <= 0 || reps <= 0) {
                alert("يا وحش! تأكد من إدخال اسم التمرين، وزن صحيح، وتكرارات صحيحة.");
                return;
            }

            const estimated1RM = calculate1RM(weight, reps);

            const entry = {
                name,
                weight,
                reps,
                date,
                estimated1RM: estimated1RM.toFixed(1), // حفظ 1RM مقرب لأقرب رقم عشري
                id: Date.now() // Unique ID for each entry
            };

            let logs = JSON.parse(localStorage.getItem('beastLogs')) || [];
            logs.unshift(entry); // Add to the beginning of the array (newest first)
            localStorage.setItem('beastLogs', JSON.stringify(logs));

            // Clear input fields
            document.getElementById('exerciseName').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('reps').value = '';

            displayLogs(); // Refresh the list of logs
            updateChart(); // Refresh the chart
        }

        // Function to display all workout logs
        function displayLogs() {
            const container = document.getElementById('logsContainer');
            const logs = JSON.parse(localStorage.getItem('beastLogs')) || [];
            
            if (logs.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-center py-8">ابدأ بتسجيل تمرينك الأول يا بطل!</p>`;
                return;
            }

            container.innerHTML = logs.map(log => `
                <div class="card-dark p-4 rounded-xl border-r-4 border-r-red-600 flex justify-between items-center transition-all duration-300 hover:shadow-red-500/20 hover:shadow-md animate-in fade-in slide-in-from-right duration-300">
                    <div>
                        <h4 class="font-bold text-lg text-white">${log.name}</h4>
                        <p class="text-sm text-gray-500 flex items-center gap-1">
                            <i data-lucide="calendar" class="w-3 h-3"></i> ${log.date}
                        </p>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <span class="text-2xl font-black text-red-500">${log.weight}</span> 
                        <span class="text-xs text-gray-400 font-bold -mt-1">KG</span>
                        <div class="text-sm font-medium text-gray-300 mt-1">بواقع ${log.reps} تكرار</div>
                        ${log.estimated1RM ? `<div class="text-xs text-gray-500 mt-1">تقريبي 1RM: ${log.estimated1RM} KG</div>` : ''}
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons(); // Re-initialize icons for new elements
        }

        // Function to update the chart
        function updateChart() {
            const logs = JSON.parse(localStorage.getItem('beastLogs')) || [];
            const container = document.getElementById('beastChart').getContext('2d');

            if (logs.length === 0) {
                // Destroy existing chart if no data, or show a message
                if (myChart) {
                    myChart.destroy();
                }
                container.clearRect(0, 0, container.canvas.width, container.canvas.height); // Clear canvas
                // Optional: display a message directly on the canvas or surrounding div
                return;
            }

            // Group logs by exercise name for individual charts (future expansion)
            // For now, we'll plot the 1RM of all exercises chronologically
            
            const chartData = [...logs].reverse(); // Sort from oldest to newest for chart display
            const labels = chartData.map(log => `${log.date} - ${log.name}`);
            const dataPoints = chartData.map(log => parseFloat(log.estimated1RM || log.weight)); // Use 1RM if available, else weight

            // Destroy existing chart instance to prevent duplicates/memory leaks
            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(container, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'تطور القوة الكلية (KG)',
                        data: dataPoints,
                        borderColor: '#ff0000', // Red color for the line
                        backgroundColor: 'rgba(255, 0, 0, 0.2)', // Light red fill under the line
                        borderWidth: 3,
                        tension: 0.4, // Makes the line curved
                        pointBackgroundColor: '#ffffff', // White points
                        pointBorderColor: '#ff0000',
                        pointRadius: 6, // Larger points
                        pointHoverRadius: 8,
                        fill: true // Fill the area under the line
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff' // Legend text color
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` ${context.dataset.label}: ${context.raw} KG`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#333' },
                            ticks: { 
                                color: '#fff',
                                callback: function(value) { return value + ' KG'; }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                color: '#fff',
                                autoSkip: true, // Automatically skip labels to prevent overlap
                                maxTicksLimit: 7 // Limit number of ticks on X-axis
                            }
                        }
                    }
                }
            });
        }

        // Function to clear all stored data
        function clearAll() {
            if(confirm("هل متأكد يا وحش؟ هذا سيمسح كل سجلاتك!")) {
                localStorage.removeItem('beastLogs');
                displayLogs();
                updateChart(); // Clear the chart as well
            }
        }

        // Load data and chart on page load
        window.onload = () => {
            displayLogs();
            updateChart();
        };
    </script>
</body>
</html>
